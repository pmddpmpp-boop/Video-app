<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Downloader</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://adsgram.ai/js/adsgram.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f5; color: #000; display: flex; flex-direction: column; align-items: center; padding-top: 50px; min-height: 100vh; margin: 0; }
        .container { width: 90%; max-width: 400px; text-align: center; background: white; padding: 30px 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .logo { font-size: 50px; margin-bottom: 15px; }
        h2 { margin: 10px 0 5px; color: #222; font-weight: 800; font-size: 24px; }
        .subtitle { font-size: 14px; color: #888; margin-bottom: 30px; }
        input { width: 100%; padding: 18px; margin-bottom: 20px; border-radius: 14px; border: 2px solid #f0f0f0; font-size: 16px; box-sizing: border-box; transition: 0.2s; outline: none; background: #fafafa; }
        input:focus { border-color: #007bff; background: #fff; }
        button { background-color: #007bff; color: white; padding: 18px 30px; border: none; border-radius: 14px; font-size: 16px; cursor: pointer; width: 100%; font-weight: 700; transition: 0.2s; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,123,255,0.2); }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
        .status { margin-top: 15px; font-size: 13px; color: #666; min-height: 20px; }
        .download-area { display: none; margin-top: 25px; border-top: 1px solid #f0f0f0; padding-top: 25px; animation: fadeIn 0.5s; }
        .video-preview { width: 100%; border-radius: 12px; margin-bottom: 15px; background: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-success { background-color: #28a745; text-decoration: none; box-shadow: 0 4px 10px rgba(40,167,69,0.2); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container">
        <div class="logo">üé•</div>
        <h2>Video Downloader</h2>
        <h3>(TikTok Only)</h3>
        <p class="subtitle">Download without watermark</p>

        <input type="text" id="videoLink" placeholder="Paste TikTok link here...">
        
        <button id="mainBtn" onclick="processLink()">
            ‚¨áÔ∏è Download Video
        </button>
        
        <p class="status" id="statusText">Ready to download.</p>

        <div id="downloadArea" class="download-area">
            <video id="vidPreview" class="video-preview" controls></video>
            <a id="downloadBtn" href="#" target="_blank" style="text-decoration: none;">
                <button class="btn-success">Save to Gallery üì•</button>
            </a>
            <button onclick="location.reload()" style="background:#f5f5f5; color:#333; margin-top:10px; box-shadow:none;">üîÑ Download Another</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ‚úÖ Block ID (Ads)
        const MyBlockID = "20348"; 

        async function processLink() {
            const link = document.getElementById('videoLink').value;
            const status = document.getElementById('statusText');
            const mainBtn = document.getElementById('mainBtn');

            if (!link) {
                status.innerText = "Please paste a link first!";
                status.style.color = "#dc3545";
                return;
            }

            status.innerText = "Please wait...";
            mainBtn.disabled = true;

            try {
                // Show Ad
                const AdController = window.Adsgram.init({ blockId: MyBlockID });
                await AdController.show().then((result) => {
                    status.innerText = "Processing video...";
                    status.style.color = "#007bff";
                    fetchVideo(link);
                }).catch((result) => {
                    status.innerText = "Ad skipped. Downloading anyway...";
                    fetchVideo(link); // Allow download even if ad skipped (optional)
                });
            } catch (e) {
                console.error(e);
                status.innerText = "Connecting...";
                fetchVideo(link); 
            }
        }

        // üîÑ New Intelligent Fetch System (Tries 2 Servers)
        async function fetchVideo(url) {
            const status = document.getElementById('statusText');
            const mainBtn = document.getElementById('mainBtn');
            
            // Server 1: TikWM (Better for short links)
            try {
                const response = await fetch(`https://www.tikwm.com/api/?url=${url}`);
                const data = await response.json();
                if (data.data && data.data.play) {
                    showSuccess(data.data.play);
                    return;
                }
            } catch (e) {
                console.log("Server 1 failed, trying Server 2...");
            }

            // Server 2: TiklyDown (Backup)
            try {
                const response = await fetch(`https://api.tiklydown.eu/api/download?url=${url}`);
                const data = await response.json();
                if (data.video && data.video.noWatermark) {
                    showSuccess(data.video.noWatermark);
                    return;
                }
            } catch (e) {
                console.log("Server 2 failed");
            }

            // If both fail
            status.innerText = "‚ùå Error. Try using a 'Long Link' not a share link.";
            status.style.color = "red";
            mainBtn.disabled = false;
        }

        function showSuccess(videoUrl) {
            const status = document.getElementById('statusText');
            const mainBtn = document.getElementById('mainBtn');
            const downloadArea = document.getElementById('downloadArea');

            status.innerText = "‚úÖ Done!";
            status.style.color = "#28a745";
            
            downloadArea.style.display = "block";
            document.getElementById('vidPreview').src = videoUrl;
            document.getElementById('downloadBtn').href = videoUrl;
            
            mainBtn.style.display = "none";
        }
    </script>
</body>
</html>
