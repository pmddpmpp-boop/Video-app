<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Downloader</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://adsgram.ai/js/adsgram.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f5; color: #000; display: flex; flex-direction: column; align-items: center; padding-top: 40px; min-height: 100vh; margin: 0; }
        .container { width: 90%; max-width: 400px; text-align: center; background: white; padding: 25px 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        
        /* Logo & Header */
        .logo { font-size: 40px; margin-bottom: 10px; }
        h2 { margin: 10px 0 5px; color: #222; font-weight: 700; }
        .subtitle { font-size: 13px; color: #666; margin-bottom: 25px; }
        .badge { background: #000; color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; }

        /* Inputs */
        input { width: 100%; padding: 16px; margin-bottom: 15px; border-radius: 12px; border: 2px solid #eee; font-size: 16px; box-sizing: border-box; transition: 0.2s; outline: none; }
        input:focus { border-color: #007bff; }

        /* Buttons */
        button { background-color: #007bff; color: white; padding: 16px 30px; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; width: 100%; font-weight: 600; transition: 0.2s; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .status { margin-top: 15px; font-size: 13px; color: #555; min-height: 20px; }
        
        /* Result Area */
        .download-area { display: none; margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 20px; animation: fadeIn 0.5s; }
        .video-preview { width: 100%; border-radius: 12px; margin-bottom: 15px; background: #000; }
        .btn-success { background-color: #28a745; text-decoration: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container">
        <div class="logo">üéµ</div>
        <h2>TikTok Downloader</h2>
        <p class="subtitle">Download videos without watermark <br> <span class="badge">TikTok Only</span></p>

        <input type="text" id="videoLink" placeholder="Paste TikTok link here...">
        
        <button id="mainBtn" onclick="processLink()">
            <span>üì∫</span> Watch Ad & Download
        </button>
        
        <p class="status" id="statusText">Server ready. Paste a link to start.</p>

        <div id="downloadArea" class="download-area">
            <video id="vidPreview" class="video-preview" controls></video>
            <a id="downloadBtn" href="#" target="_blank" style="text-decoration: none;">
                <button class="btn-success">‚¨áÔ∏è Save Video</button>
            </a>
            <button onclick="location.reload()" style="background:#f0f0f0; color:#333; margin-top:10px">üîÑ Download Another</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ‚úÖ Your Block ID is set
        const MyBlockID = "20348"; 

        async function processLink() {
            const link = document.getElementById('videoLink').value;
            const status = document.getElementById('statusText');
            const mainBtn = document.getElementById('mainBtn');

            // 1. Validation (Must be TikTok)
            if (!link || !link.includes("tiktok")) {
                status.innerText = "‚ö†Ô∏è Please paste a valid TikTok link!";
                status.style.color = "#dc3545"; // Red
                return;
            }

            // 2. Show Ad
            status.innerText = "‚è≥ Loading Ad...";
            mainBtn.disabled = true;

            try {
                const AdController = window.Adsgram.init({ blockId: MyBlockID });
                
                await AdController.show().then((result) => {
                    // ‚úÖ Ad watched -> Fetch Video
                    status.innerText = "üîÑ Processing video...";
                    status.style.color = "#007bff"; // Blue
                    fetchVideo(link);
                }).catch((result) => {
                    // ‚ùå Ad skipped/failed
                    status.innerText = "‚ö†Ô∏è You must watch the ad to download.";
                    status.style.color = "#ffc107"; // Orange
                    mainBtn.disabled = false;
                });
            } catch (e) {
                console.error(e);
                // Fallback if ad fails completely
                status.innerText = "‚ö†Ô∏è Ad error. Trying to download anyway...";
                fetchVideo(link); 
            }
        }

        // Fetch from Free API
        async function fetchVideo(url) {
            const status = document.getElementById('statusText');
            const mainBtn = document.getElementById('mainBtn');
            const downloadArea = document.getElementById('downloadArea');
            
            try {
                // Using TiklyDown Free API
                const response = await fetch(`https://api.tiklydown.eu/api/download?url=${url}`);
                const data = await response.json();

                if (data && data.video && data.video.noWatermark) {
                    // ‚úÖ Success
                    status.innerText = "‚úÖ Video Ready!";
                    status.style.color = "#28a745"; // Green
                    
                    // Show result
                    downloadArea.style.display = "block";
                    document.getElementById('vidPreview').src = data.video.noWatermark;
                    document.getElementById('downloadBtn').href = data.video.noWatermark;
                    
                    // Hide main button
                    mainBtn.style.display = "none";
                } else {
                    throw new Error("Video not found");
                }

            } catch (error) {
                status.innerText = "‚ùå Failed. Make sure the link is correct.";
                status.style.color = "red";
                mainBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
